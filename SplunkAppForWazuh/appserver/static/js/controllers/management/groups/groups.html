<div flex layout="column" class="mozilla-table-size-85 wz-white-background">
  <md-content flex layout="column" class="overflow-hidden wz-white-background">
    <div layout="row" class="layout-row layout-align-end wz-white-background">
      <div class='wz-margin-left-10 wz-margin-top-12'>
        <span class="wz-text-link cursor-pointer" ui-sref='manager'>Management</span>
        <span> / Groups </span>
      </div>
      <div flex></div>
    </div>
    <!-- Loading ring -->
    <div class='uil-ring-css' ng-show="loadingRing">
      <div></div>
    </div>

    <!-- Headline -->
    <div ng-show="!loadingRing" layout="column" layout-padding>
      <span class="font-size-18">
        <!-- Back button -->
        <md-button ng-show="lookingGroup" class="md-icon-button" aria-label="Back to groups" ng-click='reload()'>
          <i class="fa fa-fw fa-arrow-left" aria-hidden="true"></i>
          <md-tooltip md-direction="bottom" class="wz-tooltip">
            Back
          </md-tooltip>
        </md-button>
        <i class="fa fa-fw fa-object-group" aria-hidden="true"></i> Groups
      </span>
      <span>List and check your groups, its agents and files</span>
    </div>
    <!-- End headline -->

    <div flex layout="column" layout-align="start stretch" ng-show="!loadingRing" ng-init="groupsSelectedTab='agents'">
      <!-- MD5 Sums and Details cards -->
      <div layout="row" class="md-padding-h" ng-if="lookingGroup">
        <md-button class="md-icon-button wz-circle-back-button" ng-if="lookingGroup" aria-label="Back" tooltip="Go back"
          tooltip-placement="bottom" ng-click="goBackGroups()"><i class="fa fa-fw fa-arrow-left" aria-hidden="true"></i></md-button>
        <!-- Group MD5 sums section -->
        <md-card flex class="no-margin-left wz-md-card">
          <md-card-content>
            <span class="wz-headline-title wz-word-wrap wz-text-bold">{{ currentGroup.name }}</span>
            <i ng-click="editGroupAgentConfig(currentGroup); $event.stopPropagation()" class="fa fa-fw fa-file-code-o cursor-pointer action-btn-td pull-right"
              aria-hidden="true"></i>
            <md-tooltip>Edit this group agent.conf file</md-tooltip>
            <md-divider class="wz-margin-top-10"></md-divider>
            <div layout="row" class="wz-padding-top-10">
              <span flex="25">Configuration sum</span>
              <span class="wz-text-right color-grey">{{ currentGroup.configSum }}</span>
            </div>
            <div layout="row" class="wz-padding-top-10">
              <span flex="25">Merged sum</span>
              <span class="wz-text-right color-grey">{{ currentGroup.mergedSum }}</span>
            </div>
          </md-card-content>
        </md-card>
        <!-- End Group MD5 sums section -->

        <!-- Group Details section -->
        <md-card flex class="no-margin-right wz-md-card">
          <md-card-content>
            <span class="wz-headline-title">Details</span>
            <md-divider class="wz-margin-top-10"></md-divider>
            <div layout="row" class="wz-padding-top-10">
              <span flex="20" class="wz-text-link" ng-class="groupsSelectedTab==='agents' ? 'wz-text-active' : ''"
                ng-click="goBackToAgents()">Agents
                <md-tooltip md-direction="left" class="wz-tooltip">
                  Click to open the list of agent
                </md-tooltip>
              </span>
              <span class="wz-text-link" ng-click="goBackToAgents()">{{
                currentGroup.count }}
                <md-tooltip md-direction="right" class="wz-tooltip">
                  Click to open the list of agent
                </md-tooltip>
              </span>
            </div>
            <div layout="row" class="wz-padding-top-10">
              <span flex="20" class="wz-text-link" ng-class="groupsSelectedTab==='files' ? 'wz-text-active' : ''"
                ng-click="goBackFiles()">Content
                <md-tooltip md-direction="left" class="wz-tooltip">
                  Click to open the list of files
                </md-tooltip>
              </span>
              <span class="wz-text-link" ng-click="goBackFiles()">{{
                totalFiles }}
                <md-tooltip md-direction="right" class="wz-tooltip">
                  Click to open the list of files
                </md-tooltip>
              </span>
            </div>
          </md-card-content>
        </md-card>
        <!-- End Group Details section -->

      </div>
      <!-- End MD5 Sums and Details cards -->

      <!-- Group actions -->
      <div layout="row" class="md-padding" ng-if="lookingGroup && currentGroup && !addingAgents && !editingFile">
        <button ng-click='editGroupAgentConfig(currentGroup)' class='btn btn-primary'><i aria-hidden='true' class='fa fa-fw fa-file-code-o'></i>
          Edit agent.conf
        </button>
        <button ng-disabled="currentGroup.name === 'default'" ng-click='addMultipleAgents(true)' class='btn btn-primary wz-margin-left-8'><i
            aria-hidden='true' class='fa fa-fw fa-pencil'></i>
          Add or remove agents
        </button>
      </div>
      <!-- End group actions -->
      <!-- End group actions -->

      <!-- XML editor for group agents -->
      <div ng-show="editingFile">
        <div layout="row" class="md-padding">
          <span ng-click='closeEditingFile()' class='btn btn-info'>Cancel</span>
          <button ng-disabled='xmlHasErrors' ng-click='doSaveGroupAgentConfig()' class='btn btn-primary pull-right wz-margin-left-8'>
            <span ng-show='!xmlHasErrors'><i aria-hidden='true' class='fa fa-fw fa-save'></i>Save file</span>
            <span ng-show='xmlHasErrors' class='btn-danger'><i aria-hidden='true' class='fa fa-fw fa-exclamation-triangle'></i>
              XML format error</span>
          </button>
        </div>
        <div class="md-padding md-padding-top-10" ng-if="fetchedXML">
          <wz-xml-file-editor file-name='agent.conf' data="fetchedXML" target-name="currentGroup.name" valid-fn='xmlIsValid(valid)'>
          </wz-xml-file-editor>
        </div>
      </div>

      <!-- XML editor for group agents -->

      <div ng-if="!editingFile">
        <div layout="row" class="md-padding" ng-if="lookingGroup && currentGroup && addingAgents">
          <span ng-click='addMultipleAgents(false)' class='btn btn-info'>
            Cancel</span>
          <span ng-hide='moreThan1000' ng-click='saveAddAgents()' class='btn btn-primary wz-margin-left-8'><i
              aria-hidden='true' class='fa fa-fw fa-save'></i>
            Apply changes</span>
          <span class='error-msg' ng-show='moreThan1000'><i class="fa fa-exclamation-triangle"></i> It is not
            possible to apply changes of more than 1000 additions or deletions</span>
        </div>


        <!-- XML editor for group agents -->
        <div ng-if="!lookingGroup || (lookingGroup && currentGroup)">
          <wz-xml-file-editor file-name='agent.conf'>
          </wz-xml-file-editor>
        </div>
        <!-- XML editor for group agents -->

        <div ng-if='!addingAgents'>
          <!-- Search bar -->
          <div layout="row" class="md-padding" ng-if="!addingAgents">
            <input placeholder="Filter..." ng-model="custom_search" type="text" class="kuiLocalSearchInput ng-empty ng-pristine ng-scope ng-touched ng-valid"
              aria-invalid="false" wz-enter="search(custom_search)">
            <button type="submit" aria-label="Search" class="kuiLocalSearchButton height-40" ng-click="search(custom_search)">
              <span class="fa fa-search" aria-hidden="true"></span>
            </button>
          </div>
          <!-- End search bar -->

          <!-- Groups table -->
          <div layout="row" ng-if="!lookingGroup" class="md-padding">
            <wazuh-table flex extra-limit="true" path="'/agents/groups'" keys="['name','count','mergedSum']" allow-click="true"
              row-sizes="[14,12,10]">
            </wazuh-table>
          </div>
          <!-- End groups table -->

          <!-- CSV Download button section for groups -->
          <div layout="row" class="md-padding" ng-if="!lookingGroup">
            <span flex></span>
            <a class="small" id="btnDownload" ng-click="downloadCsv('/agents/groups')">Formatted
              <i aria-hidden="true" class="fa fa-fw fa-download"></i>
            </a>
          </div>
          <!-- End CSV Download button section for groups -->

          <div ng-if='!addingAgents'>
            <!-- Group agents table -->
            <div layout="row" ng-if="lookingGroup && groupsSelectedTab==='agents' && currentGroup" class="md-padding">
              <wazuh-table flex path="'/agents/groups/' + currentGroup.name" keys="['id','name','ip','status','os.name','os.version','version']"
                allow-click="true" row-sizes="[14,12,10]" />
            </div>
            <!-- End Group agents table -->

            <!-- CSV Download button section for group agents -->
            <div layout="row" class="md-padding" ng-if="lookingGroup && groupsSelectedTab==='agents'">
              <span flex></span>
              <a class="small" id="btnDownload" ng-click="downloadCsv('/agents/groups/' + currentGroup.name)">Formatted
                <i aria-hidden="true" class="fa fa-fw fa-download"></i>
              </a>
            </div>
          </div>
        </div>
        <!-- End CSV Download button section for group agents -->

        <!-- Group files table -->
        <div layout="row" ng-if="lookingGroup && groupsSelectedTab==='files' && !fileViewer && currentGroup" class="md-padding">
          <wazuh-table extra-limit="true" flex path="'/agents/groups/' + currentGroup.name + '/files'" keys="[{value:'filename',size:2},{value:'hash',size:6}]"
            allow-click="true" row-sizes="[10,8,6,4]">
          </wazuh-table>
        </div>
        <!-- End Group files table -->

        <!-- CSV Download button section for group files-->
        <div layout="row" class="md-padding" ng-if="lookingGroup && groupsSelectedTab==='files' && !file">
          <span flex></span>
          <a class="small" id="btnDownload" ng-click="downloadCsv('/agents/groups/' + currentGroup.name + '/files')">Formatted
            <i aria-hidden="true" class="fa fa-fw fa-download"></i>
          </a>
        </div>
        <!-- End CSV Download button section for group files -->

        <!-- File JSON viewer section -->
        <div flex layout="column" class="md-padding" ng-if="lookingGroup && groupsSelectedTab==='files' && file">
          <div flex layout="column">
            <div layout="row" class="wz-padding-bottom-14">
              <span flex class="wz-headline-title">{{ filename }}</span>
              <span flex class="wz-text-right cursor-pointer color-grey" ng-click="goBackFiles()">close</span>
            </div>
            <div flex layout="column">
              <pre flex class="wz-pre json-beautifier jsonbeauty2 wz-overflow-y-auto"><code wz-dynamic="file"></code></pre>
            </div>
          </div>
        </div>
      </div>
      <div layout="row" class="md-padding" ng-if="addingAgents">
        <span ng-show='!multipleSelectorLoading' class="wzMultipleSelectorCounter"><span style='color:green'>+{{currentAdding}}</span>&nbsp;<span
            style='color:red'>-{{currentDeleting}}</span></span>
        <wz-multiple-selector class='wzMultipleSelector' available-items="availableAgents.data" selected-items="selectedAgents.data"
          loading="multipleSelectorLoading" title-available-items="Available agents" title-selected-items="Current agents in the group"
          total-selected-items="totalSelectedAgents" reload-scroll='reload(element, searchTerm, 499, start)' limit="checkLimit()">
        </wz-multiple-selector>
      </div>
    </div>
  </md-content>
</div>